<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./src/app.css">
        <link rel="stylesheet" href="./src/app.css" id="csslink">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lexend">
        <title>RivETH</title>
    </head>
    
    <body>
        <nav>
            <header>
                <img src="./src/images/RivETH.png" alt="RivETH" width="50">
            </header>

            <div>RPC URL: <span id="provider"><small style="color: red;">Cannot connect to Hardhat node</small></span></div>
            <div>
                Accounts:<br/>
                <p style="display: flex;">
                    <select id="accounts">
                        <option value="---">---</option>
                    </select>
                    <button id="copy-btn" onclick="COPY_ADDRESS(this)" title="Copy Address"></button>
                    <span style="display: none;">✅</span>
                </p>
            </div>
            <div>
                Dark mode:
                <p style="display: grid; place-items: center;">
                    <label>
                        <input type="checkbox" id="theme-toggler" onchange="TOGGLE_THEME(this)">
                        <span></span>
                    </label>
                </p>
            </div>
            <div>
                <button id="eth-converter-btn">Converter</button>
            </div>
        </nav>

        <div id="contract-area">
            <div id="load-area">
                <div>
                    <div>
                        <p style="padding: .25rem;">Load Compiled Contract</p>
                        <div id="contract-loader">
                            <input type="text" id="contract-name" placeholder="Contract Name" autocomplete="off" spellcheck="false">
                            <button id="load-contract" disabled>Load</button>
                        </div>
                    </div>
    
                    <div id="deploy-contract">
                        <div id="constructor" style="display: none;">
                            <div id="eth-value">
                                <p><small>Value<br/>(wei)</small></p>&nbsp;
                                <div>
                                    <input type="number" name="ether" id="ether" min="0" step="1" value="0" placeholder="0 wei">
                                </div>
                            </div>

                            <p>Deploy <span id="name-of-compiled-contract"></span><br><small></small></p>
                            <div style="display: flex; justify-content: space-around;">
                                <input type="text" id="deploy-params" autocomplete="off" autocorrect="off">
                                <button id="deploy" disabled accesskey="A">Deploy</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="interaction-panel">
                    <p>Interact</p>
                    <p id="contract-balance" style="display: none;"></p>
                    <ul>
                        <p>
                            <small><em>No deployment found. First compile a contract and load it into RivETH.</em></small>
                        </p>
                    </ul>
                </div>
            </div>

            <div id="tx-details">
                <div id="details-wrap" style="display: none;"></div>
                <div id="intro">
                    <div id="intro-head">
                        <div>
                            <img src="./src/images/RivETH.png" alt="RivETH" width="80">
                        </div>
                        <h1>RivETH</h1>
                        <p><small><em>A local, web-based, open source Ethereum Smart Contract development toolkit.</em></small></p>
                    </div>

                    <div>
                        <div id="requirements-and-notes">
                            <div>
                                <h3>Requirements</h3>
                                <ul>
                                    <li>NodeJS. Download <a href="https://nodejs.org/en/download/current">here</a></li>
                                    <li>Hardhat.
                                    <li>Solidity compiler (solc).</li>
                                    <li>Solidity VSCode Extension by Juan Blanco or Nomic Foundation.</li>
                                    <li>VSCode Live Server Extension by Ritwick Dey.</li>
                                    <small><em style="color: red;">Verify publishers before installing any extensions.</em></small>
                                </ul>
                            </div>

                            <div>
                                <h3 style="color: red;">Notes</h3>
                                <ul>
                                    <li>You can find pre-written solidity smart contracts in the <code>contracts/</code> folder. Note that these contracts have not been reviewed and are not to be used in production.</li>
                                    <li>Do not save or write any file to the <code>artifacts/</code> folder. The solidity compiler will automatically write files to this folder.</li>
                                    <li>Use the same name for the solidity file and contract (e.g. <code>MyContract.sol</code> and <code>contract MyContract{...}</code>).</li>
                                </ul>
                            </div>
                        </div>

                        <div id="setup-and-support">
                            <div id="setup">
                                <h3>Set up</h3>
                                <ul>
                                    <li>In your terminal or git bash (for windows), create a new working directory: <code>mkdir solidity-smart-contracts</code>. You can use any name as you please.</li>
                                    <li>Download RivETH. <br/><code style="display: block; text-align: center; width: 90%; margin: auto; font-size: .8rem; margin-bottom: .25rem;">curl -L -0 https://github.com/Temi-Tade/RivETH/archive/refs/heads/main.zip --output RivETH.zip && unzip RivETH.zip -d temp && mv temp/RivETH-main/* . && rm -rf temp RivETH.zip</code></li>
                                    <li>Navigate to the <code>solidity-smart-contracts</code> folder. <code>cd RivETH</code> and open it in VSCode and install dependencies. <code>npm install</code></li>
                                    <li>In the <code>solidity-smart-contracts</code> directory in your terminal, start a local hardhat node: <pre>npx hardhat node</pre></li>
                                    <li>In a separate terminal and in your working directory, compile the smart contract's solidity code: <pre>./compile.sh ERC20.sol</pre>, for example.</li>
                                    <li>Start VSCode live server extension to open RivETH in your browser.</li>
                                    <li>Voila! You can now start writing, compiling, deploying and interacting with solidity smart contracts.</li>
                                </ul>
                            </div>

                            <div id="support">
                                <h3>Support RivETH</h3>
                                <p style="font-size: .85rem;">RivETH is an open source project that allow new web3 developers quickly prototype, deploy and interact with Ethereum Smart Contracts right inside the browser. RivETH is not meant to be the final stop but a starting point and a minimalistic development enviroment for beginners and professionals alike. After installation, every feature can be used offline! Ways you can support:</p>
                                <ul>
                                    <li><a href="https://github.com/Temi-Tade/RivETH">Star</a> the GitHub repo.</li>
                                    <li>Submitting an issue on <a href="https://github.com/Temi-Tade/RivETH">GitHub.</a></li>
                                    <li>Donating to RivETH. <button onclick="DONATE()">Donate</button></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="modalbg">
                <div id="modal">
                    <div style="display: flex; justify-content: flex-end;">
                        <button id="close-btn" title="Close">&times;</button>
                    </div>
                    <p></p>
                </div>
            </div>
        </div>
        
        <script src="./src/ui.js"></script>
    </body>
</html>

<script type="importmap">
    {
        "imports": {
            "ethers": "./node_modules/ethers/dist/ethers.js"
        }
    }
</script>

<script type="module">
import { JsonRpcProvider } from "ethers";
import { ethers } from "ethers";

if (!localStorage.getItem("RivETHSessionData")) {
    localStorage.setItem("RivETHSessionData", JSON.stringify({
        lastAccount: "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
        lastDeployedContract: ""
    }));
}

const RPC_URL = "http://127.0.0.1:8545";
const provider = new JsonRpcProvider(RPC_URL);
const contractData = {
    abi: undefined,
    bytecode: undefined,
    address: undefined,
    hasConstructor: false,
    constructorParams: 0,
    isConstructorpayable: false,
};

const txData = {
    contractAddress: undefined,
    hash: undefined,
    nonce: undefined,
    type: undefined,
    blockNumber: undefined,
    from: undefined,
    data: undefined,
    value: undefined,
    gasPrice: undefined,
    gasLimit: undefined,
    gasUsed: undefined,
    maxFeePerGas: undefined,
    maxPriorityFeePerGas: undefined
}

const txs = [];
const functions = [];
    
window.onload = async function () {
    try {
        await loadData();
    } catch (error) {
        CREATE_MODAL(`${new Error(error).message}. Cannot connect, is the node running?`);
    }
}

document.querySelector("#contract-name").oninput = function (input) {
    if (input.target.value.trim().length > 0) {
        input.target.nextElementSibling.disabled = false;
    } else {
        input.target.nextElementSibling.disabled = true;
    }
}

async function loadData() {
    try {
        const _provider = RPC_URL;
        const accounts = await provider.listAccounts();
        const network = await provider._detectNetwork();
        const blockNumber = await provider.getBlockNumber();
    
        document.querySelector("#provider").innerHTML = ` ${_provider}<small style='color: #11fd34'>(Connected)</small>`;
        document.querySelector("#accounts").innerHTML = "";
    
        accounts.forEach(async (account) => {
            let accountBalance = Number(await provider.getBalance(account.address)) / 1e18;
            let formattedAddress = account.address.replace(account.address.substring(7, 35), "....")
            document.querySelector("#accounts").innerHTML += `<option value=${account.address}>${formattedAddress} (${accountBalance} ETH)</option>`
        });
    
        setTimeout(() => {
            if (localStorage.getItem("RivETHSessionData")) {
                const lastAccount = JSON.parse(localStorage.getItem("RivETHSessionData")).lastAccount;
                document.querySelector("#accounts").value = lastAccount || accounts[0].address;
                if (txs.length > 0) getContractBalance(contractData.address);
            }
        }, 1000);

        // load theme
        const savedTheme = JSON.parse(localStorage.getItem("RivETHSessionData")).theme;
        if (savedTheme === "light") {
            document.querySelector("#csslink").href = "";
        } else {
            document.querySelector("#csslink").href = "./src/darkmode.css";
            document.querySelector("input[type=checkbox]").checked = true;
        }
    } catch (error) {
        CREATE_MODAL(`${new Error(error).message}. Cannot connect, is the node running?`);
    }
}

async function getContractBalance(contractAddress) {
    await provider.getBalance(contractAddress).then(balance => {
        const contractBalance = ethers.formatEther(balance);
        document.querySelector("#contract-balance").style.display = "block";
        document.querySelector("#contract-balance").innerHTML = `<small>Balance: ${contractBalance} ETH</small>`;
    })
}

document.querySelector("#load-contract").onclick = async function(e) {
    try {
        document.querySelector("#deploy-params").disabled = true;

        const abi = fetch(`http://127.0.0.1:5500/artifacts/${e.target.previousElementSibling.value.trim()}.abi`);
        const bin = fetch(`http://127.0.0.1:5500/artifacts/${e.target.previousElementSibling.value.trim()}.bin`);
            
        await Promise.all([abi, bin])
        .then(res => {
            contractData.abi = res[0].text();
            contractData.bytecode = res[1].text();
        })
            
        await contractData.abi
        .then(res => contractData.abi = res);
            
        await contractData.bytecode
        .then(res => contractData.bytecode = res);
            
        if (JSON.parse(contractData.abi)[0].type === "constructor") {
            let constructorParams = [];
            contractData.hasConstructor = true;
    
            JSON.parse(contractData.abi)[0].inputs.forEach(param => {
                constructorParams.push(param);
            });
                
            document.querySelector("#constructor").style.display = "block";
            document.querySelector("#deploy-params").placeholder = "";
            contractData.constructorParams = constructorParams.length;

            if (constructorParams.length === 0) {
                document.querySelector("#deploy").disabled = false;
                document.querySelector("#deploy-params").disabled = true;
                document.querySelector("#deploy-params").placeholder = "No constructor args";
            } else {
                document.querySelector("#deploy-params").disabled = false;
            }

            document.querySelector("#name-of-compiled-contract").textContent = document.querySelector("#contract-name").value.trim();
    
            constructorParams.forEach(param => {
                document.querySelector("#deploy-params").placeholder += `${param.type} ${param.name}, `
            });
    
            if (JSON.parse(contractData.abi)[0].stateMutability === "payable") {
                contractData.isConstructorpayable = true;
            }
        } else {
            // alert();
            document.querySelector("#constructor").style.display = "block";
            document.querySelector("#deploy").disabled = false;
            document.querySelector("#deploy-params").disabled = true;
            document.querySelector("#deploy-params").placeholder = "No constructor found";
        }
    } catch (error) {
        CREATE_MODAL("Error locating compiled contract. Run <pre>solc [FILE_NAME].sol --abi --bin -o ./artifacts/</pre>. Replace [FILE_NAME] with the name of the solidity file you want to compile");
    }
}

function createInteractionButtons(entry) {    
    document.querySelector("#interaction-panel ul").innerHTML += `
        <li>
            <div class='wrap'>
                <div><button data-name="${entry.name || entry.type}" data-outputs=${JSON.stringify(entry.outputs)} id="${entry.name || entry.type}" class='${entry.type !== "receive" && entry.type !== "fallback" ? "contract-function" : ""} ${entry.stateMutability}'>${entry.name || entry.type}</button></div>
                <p></p>
            </div>
            <output id="result-${entry.name || entry.type}"></output>
        </li>
    `;
}

function getFunctions() {
    functions.length = 0;
    const contractABIJSON = JSON.parse(contractData.abi);
    document.querySelector("#interaction-panel ul").innerHTML = "";
        
    contractABIJSON.forEach((entry) => {
        if (
            entry.type === "function" &&
            entry.name && 
            (
                entry.stateMutability === 'view' || 
                entry.stateMutability === 'pure' || 
                entry.stateMutability === 'nonpayable' || 
                entry.stateMutability === 'payable'
            )
        ) {
            functions.push(entry);
            createInteractionButtons(entry);
        }
    })

    contractABIJSON.forEach(entry => {
        if (entry.type === "receive" || entry.type === "fallback") {
            createInteractionButtons(entry);
        }
        
        if (entry.type === "fallback") {
            document.querySelector("#fallback").parentElement.nextElementSibling.innerHTML = `<input placeholder="Message" id="fallback-message" autocomplete="off" spellcheck="false"/>`
        }
    })
    
    // create inputs for functions with params
    functions.map((func, ind) => {
        if (func.name && func.inputs.length !== 0) {
            func.inputs.map(f => {
                [...document.querySelectorAll("#interaction-panel ul li div p")][ind].innerHTML += `<input placeholder="${f.type} ${f.name}" data-type="${f.type}" autocomplete="off" spellcheck="false"/>`
            });
        }
    })
}

function getTxData(transactionData) {
    document.querySelector("#intro").style.display = "none";
    document.querySelector("#tx-details #details-wrap").style.display = "block";
    document.querySelector("#tx-details #details-wrap").innerHTML += `<table id=${transactionData.hash} style="scroll-behavior: smooth;"><caption>✅ Tx: ${transactionData.hash}</caption></table>`;

    for (const key in transactionData) {
        if (txData[key] === undefined) continue;
        document.getElementById(transactionData.hash).innerHTML += `
            <tr>
                <td>${key}</td>
                <td>${(key !== "value") && (key !== "gasPrice") && (key !== "gasLimit") && (key !== "maxFeePerGas") && (key !== "maxPriorityFeePerGas") && (key !== "gasUsed") ? transactionData[key] : `${transactionData[key]} wei`} ${key === "gasUsed" ? `<em> (${(Number(transactionData[key])*100)/Number(transactionData["gasLimit"])}` + "%)</em>" : ""}</td>
            </tr>
        `
    }
    document.getElementById(transactionData.hash).scrollIntoView();
}

async function handleFallbackAndReceiveTxs(response, receipt) {
    for (const key in txData) {
        txData[key] = response[key];
    }
    txData.gasUsed = receipt.gasUsed;

    let sessionData = JSON.parse(localStorage.getItem("RivETHSessionData"));
    localStorage.setItem("RivETHSessionData", JSON.stringify({
        ...sessionData,
        lastAccount: document.querySelector("#accounts").value
    }));

    txs.push(await txData);

    getTxData(txData);
    await loadData();
}
    
document.querySelector("#deploy").onclick = async function() {
    try {
        const signer = await provider.getSigner(document.querySelector("#accounts").selectedIndex);
        const deploymentOverrides = {};

        let deployParams = [];
        if (contractData.hasConstructor) {
            document.querySelector("#deploy-params").value.trim().split(", ").forEach(param => {
                deployParams.push(JSON.parse(param));
            })
            console.log(...deployParams.toString().split(", "));
            
            if (contractData.isConstructorpayable) {
                deploymentOverrides.value = BigInt(document.querySelector("#ether").value.toString());
            }
        }
        
        let contract;
        const factory = new ethers.ContractFactory(contractData.abi, contractData.bytecode, signer);
        
        if (contractData.constructorParams >= 1) {
            contract = await factory.deploy(...deployParams, deploymentOverrides);
            await contract.waitForDeployment();
        } else {
            contract = await factory.deploy(deploymentOverrides);
            await contract.waitForDeployment();
        }
        const txResponse = await contract.deploymentTransaction();
        const txReceipt = await txResponse.wait();

        for (const key in txData) {
            txData[key] = txResponse[key];
        }

        txData.gasUsed = txReceipt.gasUsed;
        txData.contractAddress = await contract.getAddress();
        contractData.address = await contract.getAddress();
        txs.push(await txData);

        getTxData(txData);
        getFunctions();
        
        localStorage.setItem("RivETHSessionData", JSON.stringify({
            lastAccount: document.querySelector("#accounts").value,
            lastDeployedContract: txData.contractAddress
        }));

        JSON.parse(contractData.abi).forEach(entry => {
            if (entry.type === "receive" || entry.type === "fallback") {
                document.querySelector("#fallback").onclick = async function() {
                    try {
                        const signer = await provider.getSigner(document.querySelector("#accounts").selectedIndex);

                        const fallbackTx = await signer.sendTransaction({
                            to: txData.contractAddress || JSON.parse(localStorage.getItem("RivETHSessionData")).lastDeployedContract,
                            value: BigInt(document.querySelector("#ether").value.toString()),
                            data: ethers.toUtf8Bytes(document.querySelector("#fallback-message").value.trim())
                        });
                        const txReceipt = await fallbackTx.wait();
                        handleFallbackAndReceiveTxs(fallbackTx, txReceipt);
                    } catch (error) {
                        CREATE_MODAL(new Error(error).message);
                    }
                } 
        
                document.querySelector("#receive").onclick = async function() {
                    try {
                        const signer = await provider.getSigner(document.querySelector("#accounts").selectedIndex);

                        const receiveTx = await signer.sendTransaction({
                            to: txData.contractAddress || JSON.parse(localStorage.getItem("RivETHSessionData")).lastDeployedContract,
                            value: BigInt(document.querySelector("#ether").value.toString()),
                        });
                        const txReceipt = await receiveTx.wait();
                        handleFallbackAndReceiveTxs(receiveTx, txReceipt);
                    } catch (error) {
                        CREATE_MODAL(new Error(error).message);
                    }
                };
            }
        });

        [...document.querySelectorAll(".contract-function")].forEach((btn, ind) => {
            btn.onclick = async function() {
                try {
                    const signer = await provider.getSigner(document.querySelector("#accounts").selectedIndex);

                    let args = Array.from(btn.parentElement.nextElementSibling.querySelectorAll("input")).map(input => {
                        return JSON.parse(input.value);
                    });

                    const resultElement = btn.parentElement.parentElement.nextElementSibling;
    
                    let result;
                    
                    if (btn.classList.contains("pure") || btn.classList.contains("view")) {
                        result = await contract[btn.dataset.name](...args);
                    } else {
                        const signer = await provider.getSigner(document.querySelector("#accounts").selectedIndex);
                        const contractWithSigner = contract.connect(signer);
                        const txOptions = {};
                        
                        if (btn.classList.contains("payable") && BigInt(document.querySelector("#ether").value) !== 0) {
                            txOptions.value = BigInt(document.querySelector("#ether").value).toString();
                        }
                        
                        const contractTxResponse = await contractWithSigner[btn.dataset.name](...args, txOptions);
                        const txReceipt = await contractTxResponse.wait();
                        
                        for (const key in txData) {
                            txData[key] = contractTxResponse[key];
                        }
                        txData.gasUsed = txReceipt.gasUsed;

                        let sessionData = JSON.parse(localStorage.getItem("RivETHSessionData"));

                        localStorage.setItem("RivETHSessionData", JSON.stringify({
                            ...sessionData,
                            lastAccount: document.querySelector("#accounts").value,
                        }));

                        txs.push(await txData);

                        getTxData(txData);
                        await loadData();
                    }
                    
                    if (typeof result === "bigint") {
                        resultElement.innerHTML = result;
                    } else {
                        if (typeof result  === "undefined") result = "";
                        resultElement.innerHTML = typeof result === "string" ? result.trim() : result;
                    }
                } catch (error) {
                        CREATE_MODAL(new Error(error).message);
                }
            }
        });

        await loadData();

    } catch (error) {
        CREATE_MODAL(new Error(error).message);
    }
}

document.querySelector("#deploy-params").oninput = function(e) {
    if (contractData.hasConstructor) {
        if (e.target.value.trim().split(", ").length === contractData.constructorParams && e.target.value.trim().split(", ")[contractData.constructorParams - 1] !== "") {
            document.querySelector("#deploy").disabled = false;
        } else {
            document.querySelector("#deploy").disabled = true;
        }
    }
}

document.querySelector("#eth-converter-btn").onclick = function() {
    CREATE_MODAL(`
        <h3>ETH Converter</h3>
        <div>
            <div class='converter-field'>
                <label>WEI </label>
                <input type="number" min="0" value="1" id="wei" autofocus>
            </div>

            <div class='converter-field'>
                <label>GWEI </label>
                <input type="number" min="0" value=${ethers.formatUnits("1", "gwei")} id="gwei" readonly>
            </div>

            <div class='converter-field'>
                <label>ETH </label>
                <input type="number" min="0" value=${ethers.formatEther("1")} id="ethvalue" readonly>
            </div>
        </div>
    `);

    document.querySelector("#wei").oninput = function(e) {
        const weiValue = e.target.value;
        if (weiValue === "") {
            return;
        } else if (weiValue < 1) {
            return;
        }
        document.querySelector("#gwei").value = ethers.formatUnits(weiValue.toString(), "gwei");
        document.querySelector("#ethvalue").value = ethers.formatEther(weiValue.toString());
    }
}
</script>